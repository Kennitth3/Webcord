<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WebCord Online</title>
<style>
body{margin:0;display:flex;height:100vh;font-family:sans-serif;background:#2f3136;color:white;}
#servers{width:80px;background:#202225;display:flex;flex-direction:column;align-items:center;padding:10px;overflow-y:auto;}
#channels{width:220px;background:#2f3136;padding:10px;overflow-y:auto;}
#chat{flex:1;display:flex;flex-direction:column;background:#36393f;}
#chatHeader{padding:10px;background:#2f3136;border-bottom:1px solid #202225;display:flex;align-items:center;}
#messages{flex:1;overflow-y:auto;padding:10px;}
#input{display:flex;padding:10px;background:#40444b;}
#input input[type=text]{flex:1;padding:8px;border:none;border-radius:5px;}
#input input[type=file]{display:none;}
#input button{margin-left:5px;padding:8px 12px;border:none;border-radius:5px;background:#5865f2;color:white;cursor:pointer;}
.server,.channel{padding:8px;margin:4px 0;border-radius:5px;cursor:pointer;background:#36393f;text-align:center;}
.server:hover,.channel:hover{background:#5865f2;}
#authBox{padding:10px;background:#2f3136;font-size:12px;display:flex;flex-direction:column;}
#authBox input{width:100%;margin:2px 0;padding:4px;}
#authBox button{margin:2px 0;width:100%;padding:4px;}
.message{margin:6px 0;display:flex;align-items:flex-start;}
.avatar{width:36px;height:36px;border-radius:50%;margin-right:8px;}
.user{font-weight:bold;color:#00b0f4;margin-right:6px;}
.about{font-size:12px;color:#b9bbbe;margin-bottom:2px;}
#userPanel{display:flex;align-items:center;padding:8px;margin-bottom:8px;background:#2f3136;border-radius:5px;}
#userPanel img{width:40px;height:40px;border-radius:50%;margin-right:8px;cursor:pointer;}
#profileBtn{margin-left:auto;padding:4px 8px;background:#5865f2;border:none;border-radius:5px;cursor:pointer;color:white;}
.message img.msgImg{max-width:200px;max-height:200px;border-radius:5px;margin-top:4px;}
</style>
</head>
<body>
<div id="servers">
<h3>Servers</h3>
<div id="serverList"></div>
<button onclick="createServer()">+</button>
</div>
<div id="channels">
<div id="authBox">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<input id="username" placeholder="Username">
<button onclick="register()">Register</button>
<button onclick="login()">Login</button>
</div>
<div id="userPanel" style="display:none;">
<img id="userAvatar" src="" onclick="changePFP()">
<div>
<div id="userName"></div>
<div id="userAbout"></div>
</div>
<button id="profileBtn" onclick="editProfile()">Edit</button>
<button onclick="logout()" style="margin-left:4px;padding:4px 8px;background:#f04747;border:none;border-radius:5px;color:white;cursor:pointer;">Logout</button>
</div>
<h3>Channels</h3>
<div id="channelList"></div>
<button onclick="createChannel()">+</button>
</div>
<div id="chat">
<div id="chatHeader">Welcome to WebCord</div>
<div id="messages"></div>
<div id="input">
<input type="text" id="msgInput" placeholder="Type a message...">
<input type="file" id="msgFile" accept="image/png">
<button onclick="document.getElementById('msgFile').click()">ðŸ“Ž</button>
<button onclick="sendMessage()">Send</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, set, get, push, onChildAdded, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCSou4NAkrr9TQcDPlxddfl8JAUI-DueaI",
  authDomain: "webcord-a1c2e.firebaseapp.com",
  databaseURL: "https://webcord-a1c2e-default-rtdb.firebaseio.com",
  projectId: "webcord-a1c2e",
  storageBucket: "webcord-a1c2e.appspot.com",
  messagingSenderId: "791064270108",
  appId: "1:791064270108:web:86d56cb8ec71bc828d16d9"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser=null;
let userProfile=null;
let currentServer=null;
let currentChannel=null;

// ---------- Auth ----------
onAuthStateChanged(auth, async (user)=>{
currentUser=user;
if(user){
  const snap=await get(ref(db,'users/'+user.uid));
  userProfile=snap.exists()?snap.val():null;
  document.getElementById("authBox").style.display="none";
  document.getElementById("userPanel").style.display="flex";
  document.getElementById("userAvatar").src=userProfile?.avatar||`https://i.pravatar.cc/150?u=${user.uid}`;
  document.getElementById("userName").innerText=userProfile?.username||user.email;
  document.getElementById("userAbout").innerText=userProfile?.about||"";
  loadServers();
}else{
  document.getElementById("authBox").style.display="flex";
  document.getElementById("userPanel").style.display="none";
  currentServer=null; currentChannel=null;
  document.getElementById("serverList").innerHTML="";
  document.getElementById("channelList").innerHTML="";
  document.getElementById("messages").innerHTML="";
  document.getElementById("chatHeader").innerText="Welcome to WebCord";
}
});

// ---------- Auth Functions ----------
async function register(){
const email=document.getElementById("email").value;
const pass=document.getElementById("password").value;
const username=document.getElementById("username").value||email.split("@")[0];
const cred=await createUserWithEmailAndPassword(auth,email,pass);
await set(ref(db,'users/'+cred.user.uid),{username,avatar:'https://i.pravatar.cc/150?u='+cred.user.uid,about:""});
}

async function login(){
const email=document.getElementById("email").value;
const pass=document.getElementById("password").value;
await signInWithEmailAndPassword(auth,email,pass);
}

async function logout(){await signOut(auth);}

// ---------- Profile ----------
async function editProfile(){
const newName=prompt("Username:",userProfile.username);
const newAbout=prompt("About me:",userProfile.about||"");
if(!newName) return;
await update(ref(db,'users/'+currentUser.uid),{username:newName,about:newAbout});
userProfile.username=newName; userProfile.about=newAbout;
document.getElementById("userName").innerText=newName;
document.getElementById("userAbout").innerText=newAbout;
}

async function changePFP(){
const input=document.createElement('input'); input.type='file'; input.accept='image/png';
input.onchange=async e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=async ev=>{
    const base64=ev.target.result;
    await update(ref(db,'users/'+currentUser.uid),{avatar:base64});
    userProfile.avatar=base64;
    document.getElementById("userAvatar").src=base64;
  };
  reader.readAsDataURL(file);
};
input.click();
}

// ---------- Servers ----------
const displayedServers = new Set();
async function loadServers(){
  const serverList = document.getElementById("serverList");
  serverList.innerHTML = "";
  displayedServers.clear();
  const serversRef = ref(db,'servers');

  // Load existing servers
  try{
    const snap = await get(serversRef);
    if(snap.exists()){
      Object.entries(snap.val()).forEach(([id,data])=>{
        addServerToDOM(id,data);
      });
    } else if(currentUser){
      const defaultRef = push(serversRef);
      const serverData = { name: "Welcome Server", owner: currentUser.uid, members: {[currentUser.uid]:true}, channels:{} };
      await set(defaultRef, serverData);
      addServerToDOM(defaultRef.key, serverData);
    }
  } catch(err){console.error(err);}

  onChildAdded(serversRef, snap=>{
    addServerToDOM(snap.key,snap.val());
  });
}

function addServerToDOM(id,data){
  if(displayedServers.has(id)) return;
  displayedServers.add(id);
  const serverList = document.getElementById("serverList");
  const div = document.createElement("div");
  div.className = "server";
  div.innerText = data.name || "Unnamed Server";
  div.style.cursor="pointer";
  div.onclick = ()=>joinServer(id,data.name);
  serverList.appendChild(div);
}

async function createServer(){
  if(!currentUser) return;
  const name = prompt("Server name?"); if(!name) return;
  const serversRef = ref(db,'servers');
  const serverRef = push(serversRef);
  const serverData = { name, owner: currentUser.uid, members:{[currentUser.uid]:true}, channels:{} };
  await set(serverRef, serverData);
  addServerToDOM(serverRef.key, serverData);
}

// ---------- Channels ----------
let displayedChannels = new Set();
function joinServer(serverId,serverName){
  currentServer = serverId;
  document.getElementById("chatHeader").innerText=`Server: ${serverName}`;
  document.getElementById("messages").innerHTML="";
  loadChannels();
}

function loadChannels(){
  const channelList = document.getElementById("channelList");
  channelList.innerHTML="";
  displayedChannels.clear();
  const channelsRef = ref(db,`servers/${currentServer}/channels`);

  get(channelsRef).then(snap=>{
    if(snap.exists()){
      Object.entries(snap.val()).forEach(([id,data])=>{
        addChannelToDOM(id,data);
      });
    }
  });

  onChildAdded(channelsRef,(snap)=>{
    addChannelToDOM(snap.key,snap.val());
  });
}

function addChannelToDOM(id,data){
  if(displayedChannels.has(id)) return;
  displayedChannels.add(id);
  const div = document.createElement("div");
  div.className = "channel";
  div.innerText = data.name || "Unnamed Channel";
  div.style.cursor = "pointer";
  div.onclick = ()=>selectChannel(id,data.name);
  document.getElementById("channelList").appendChild(div);
}

async function createChannel(){
  if(!currentServer) return;
  const name=prompt("Channel name?"); if(!name) return;
  const channelRef = push(ref(db,`servers/${currentServer}/channels`));
  await set(channelRef,{name});
}

// ---------- Messages ----------
let displayedMessages = new Set();
function selectChannel(channelId,name){
  currentChannel=channelId;
  document.getElementById("chatHeader").innerText="Channel: "+name;
  document.getElementById("messages").innerHTML="";
  displayedMessages.clear();
  loadMessages();
}

function loadMessages(){
  if(!currentServer || !currentChannel) return;
  const messagesRef = ref(db,`servers/${currentServer}/channels/${currentChannel}/messages`);

  get(messagesRef).then(snap=>{
    if(snap.exists()){
      Object.entries(snap.val()).forEach(([id,msg])=>{
        addMessageToDOM(id,msg);
      });
    }
  });

  onChildAdded(messagesRef, snap=>{
    addMessageToDOM(snap.key,snap.val());
  });
}

function addMessageToDOM(id,msg){
  if(displayedMessages.has(id)) return;
  displayedMessages.add(id);
  const div=document.createElement("div"); div.className="message";
  div.innerHTML=`<img class="avatar" src="${msg.avatar||'https://i.pravatar.cc/32'}"><div><div class="user">${msg.username||msg.uid}</div><div class="about">${msg.text||''}</div>${msg.image?`<img class="msgImg" src="${msg.image}">`:''}</div>`;
  const messagesEl=document.getElementById("messages");
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Make sure currentServer, currentChannel, currentUser, and userProfile are all set
function sendMessage() {
  if (!currentUser || !currentServer || !currentChannel) {
    alert("Please select a server and a channel!");
    return;
  }

  const text = document.getElementById("msgInput").value.trim();
  const file = document.getElementById("msgFile").files[0];

  if (!text && !file) return;

  const msgRef = push(ref(db, `servers/${currentServer}/channels/${currentChannel}/messages`));

  if (file) {
    if (file.size > 500000) { alert("File too large! Max 500KB"); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      set(msgRef, {
        uid: currentUser.uid,
        username: userProfile.username,
        avatar: userProfile.avatar,
        text: text || "",
        image: e.target.result,
        timestamp: Date.now()
      }).then(() => {
        document.getElementById("msgInput").value = "";
        document.getElementById("msgFile").value = "";
      }).catch(err => console.error("Error sending message:", err));
    };
    reader.readAsDataURL(file);
  } else {
    set(msgRef, {
      uid: currentUser.uid,
      username: userProfile.username,
      avatar: userProfile.avatar,
      text: text,
      image: "",
      timestamp: Date.now()
    }).then(() => {
      document.getElementById("msgInput").value = "";
    }).catch(err => console.error("Error sending message:", err));
  }
}


// Expose globally
window.register=register; window.login=login; window.logout=logout;
window.createServer=createServer; window.createChannel=createChannel;
window.sendMessage=sendMessage; window.editProfile=editProfile; window.changePFP=changePFP;

</script>
</body>
</html>
